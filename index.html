<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Uploader Multi-Cuenta</title>

  <!-- Clave por defecto para Uploadcare -->
  <script>
    UPLOADCARE_PUBLIC_KEY = 'd7638f5a88dbee59f6df';
  </script>

  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Decorative Blobs -->
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>

  <div class="container">
    <h2>ðŸ“¤ Uploader Multi-Cuenta</h2>
    <div id="account-buttons"></div>

    <input
      type="hidden"
      role="uploadcare-uploader"
      id="uploader"
      data-multiple="true"
      data-instant="false"
    />

    <button class="download" onclick="downloadCSV()">ðŸ“¥ Descargar CSV</button>
  </div>

  <script>
    const accounts = {
      Cuenta_1: 'd7638f5a88dbee59f6df',
      Cuenta_2: '0c66cc01e66de4ec45ad',
      Cuenta_3: '0cd1cb40ac781484a4ce',
      Cuenta_4: '6e4c476a4ce09f440217',
      Cuenta_5: '3124b74564244bcc9612'
    };

    let currentAccount = null;
    let currentWidget = null;

    function renderButtons() {
      const container = document.getElementById('account-buttons');
      container.innerHTML = '';

      Object.keys(accounts).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.className = 'account-button';
        if (currentAccount === name) btn.classList.add('active');
        btn.onclick = () => setAccount(name);
        container.appendChild(btn);
      });
    }

    function setAccount(name) {
      currentAccount = name;
      UPLOADCARE_PUBLIC_KEY = accounts[name];
      renderButtons();

      const input = document.getElementById('uploader');
      uploadcare.destroyAll();
      currentWidget = uploadcare.Widget(input, {
        publicKey: accounts[name]
      });

      console.log(`âœ… Cuenta activa: ${name}`);
    }

    async function downloadCSV() {
      if (!currentWidget) {
        alert('SeleccionÃ¡ una cuenta y subÃ­ imÃ¡genes.');
        return;
      }

      const result = await currentWidget.value();
      let urls = [];

      if (result && typeof result.files === 'function') {
        const files = await result.files();
        for (const f of files) {
          const file = await f.promise();
          urls.push(file.cdnUrl);
        }
      } else if (result) {
        const file = await result.promise();
        urls.push(file.cdnUrl);
      }

      if (urls.length === 0) {
        alert('No se subieron imÃ¡genes.');
        return;
      }

      let csv = 'image\n' + urls.join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'imagenes.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    window.onload = () => {
      const defaultAccount = Object.keys(accounts)[0];
      setAccount(defaultAccount);
    };
  </script>
</body>
</html>
